#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start the Gym Lockers service
# ==============================================================================

# Set environment variables from config
export DB_HOST=$(bashio::config 'database.host')
export DB_PORT=$(bashio::config 'database.port')
export DB_NAME=$(bashio::config 'database.name')
export DB_USER=$(bashio::config 'database.username')
export DB_PASSWORD=$(bashio::config 'database.password')

# MQTT Configuration
if bashio::config.true 'mqtt.use_internal'; then
    export MQTT_HOST="localhost"
    export MQTT_PORT="1883"
    export MQTT_USERNAME=""
    export MQTT_PASSWORD=""
else
    export MQTT_HOST=$(bashio::config 'mqtt.external.host')
    export MQTT_PORT=$(bashio::config 'mqtt.external.port')
    export MQTT_USERNAME=$(bashio::config 'mqtt.external.username')
    export MQTT_PASSWORD=$(bashio::config 'mqtt.external.password')
fi

# System settings
export AUTO_REFRESH=$(bashio::config 'system.auto_refresh')
export DATA_RETENTION=$(bashio::config 'system.data_retention')
export DEBUG_MODE=$(bashio::config 'system.debug_mode')

# Start supervisord which manages all our services
exec /usr/bin/supervisord -c /etc/supervisor/conf.d/supervisord.conf